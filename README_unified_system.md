# ç»Ÿä¸€æ£€ç´¢ç³»ç»Ÿ - é›†æˆè§†é¢‘ç›‘æ§ä¸æ¡Œé¢æ´»åŠ¨

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿå°†è§†é¢‘ç›‘æ§RAGæ£€ç´¢å’Œæ¡Œé¢æ´»åŠ¨æ£€ç´¢æ•´åˆä¸ºä¸€ä¸ªç»Ÿä¸€çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒï¼š

- ğŸ¥ **è§†é¢‘ç›‘æ§æŸ¥è¯¢**: åŸºäºç›‘æ§è®°å½•çš„æ™ºèƒ½æ£€ç´¢
- ğŸ’» **æ¡Œé¢æ´»åŠ¨æŸ¥è¯¢**: åŸºäºå±å¹•æˆªå›¾å’Œåº”ç”¨ä½¿ç”¨çš„æ£€ç´¢  
- ğŸ” **ç»¼åˆæŸ¥è¯¢**: åŒæ—¶æŸ¥è¯¢ä¸¤ä¸ªç³»ç»Ÿå¹¶æ™ºèƒ½åˆå¹¶ç»“æœ
- ğŸ“Š **æ´»åŠ¨æ€»ç»“**: ç”ŸæˆæŒ‡å®šæ—¶é—´èŒƒå›´çš„ç»¼åˆæ´»åŠ¨æŠ¥å‘Š

## æ¶æ„è®¾è®¡

```
ğŸ“± ç”¨æˆ·æŸ¥è¯¢
    â†“
ğŸ§  ç»Ÿä¸€æ£€ç´¢æ¥å£ (unified_retriever.py)
    â†“
ğŸ” æ„å›¾è¯†åˆ«
    â†“
ğŸ“Š æ™ºèƒ½è·¯ç”±
    â”œâ”€â”€ è§†é¢‘ç›‘æ§ç³»ç»Ÿ (rag_server.py)
    â”œâ”€â”€ æ¡Œé¢æ´»åŠ¨ç³»ç»Ÿ (activity_retriever.py)  
    â””â”€â”€ ç»¼åˆæŸ¥è¯¢ (å¹¶è¡Œ+LLMåˆå¹¶)
    â†“
ğŸ’¬ ç»Ÿä¸€å“åº”æ ¼å¼
```

## æ–‡ä»¶ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ unified_retriever.py          # ç»Ÿä¸€æ£€ç´¢æ ¸å¿ƒ
â”œâ”€â”€ rag_server.py                 # è§†é¢‘ç›‘æ§RAGæœåŠ¡ (å·²ä¿®æ”¹)
â”œâ”€â”€ activity_retriever.py         # æ¡Œé¢æ´»åŠ¨æ£€ç´¢
â”œâ”€â”€ usage_example.py              # ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•
â”œâ”€â”€ README_unified_system.md      # æœ¬æ–‡æ¡£
â”œâ”€â”€ chroma_db/                    # è§†é¢‘ç›‘æ§å‘é‡æ•°æ®åº“
â”œâ”€â”€ chroma_db_activity/           # æ¡Œé¢æ´»åŠ¨å‘é‡æ•°æ®åº“
â””â”€â”€ screen_recordings/            # æ¡Œé¢æ´»åŠ¨åŸå§‹æ•°æ®
    â””â”€â”€ activity_log.db          # SQLiteæ•°æ®åº“
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install fastapi uvicorn
pip install langchain-community chromadb 
pip install dateparser aiohttp
pip install requests

# ç¡®ä¿åµŒå…¥æ¨¡å‹å¯ç”¨
pip install sentence-transformers
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ä¸»æœåŠ¡å™¨
python rag_server.py

# æˆ–ä½¿ç”¨uvicorn
uvicorn rag_server:app --host 0.0.0.0 --port 8085
```

### 3. æµ‹è¯•ç³»ç»Ÿ

```bash
# è¿è¡Œæµ‹è¯•ç¤ºä¾‹
python usage_example.py
```

## APIæ¥å£

### ç»Ÿä¸€æŸ¥è¯¢æ¥å£

**POST** `/unified_query/`

```json
{
    "query": "æˆ‘æ˜¨å¤©ä¸‹åˆç”¨äº†ä»€ä¹ˆè½¯ä»¶ï¼Ÿ"
}
```

**å“åº”:**
```json
{
    "status": "success",
    "answer": "æ ¹æ®è®°å½•ï¼Œæ‚¨æ˜¨å¤©ä¸‹åˆä¸»è¦ä½¿ç”¨äº†...",
    "query_type": "desktop_only",
    "source": "desktop_system"
}
```

### æ¯æ—¥æ€»ç»“æ¥å£

**POST** `/daily_summary/`

```json
{}
```

**å“åº”:**
```json
{
    "status": "success", 
    "summary": "ä»Šå¤©æ‚¨çš„ä¸»è¦æ´»åŠ¨åŒ…æ‹¬...",
    "time_range": "2024-01-15 00:00 è‡³ 2024-01-15 23:59"
}
```

## æŸ¥è¯¢ç±»å‹è¯†åˆ«

ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æŸ¥è¯¢æ„å›¾å¹¶è·¯ç”±åˆ°ç›¸åº”ç³»ç»Ÿï¼š

### æ¡Œé¢æ´»åŠ¨å…³é”®è¯
- `æ¡Œé¢`, `å±å¹•`, `è½¯ä»¶`, `åº”ç”¨`, `ç¨‹åº`, `çª—å£`
- `æµè§ˆå™¨`, `ç½‘é¡µ`, `Chrome`, `VSCode`
- `æ‰“å¼€`, `ä½¿ç”¨`, `æ“ä½œ`, `ç‚¹å‡»`

### è§†é¢‘ç›‘æ§å…³é”®è¯  
- `ç›‘æ§`, `æ‘„åƒå¤´`, `å‘ç°`, `æ£€æµ‹åˆ°`
- `è§†é¢‘`, `ç”»é¢`, `æ‹åˆ°`, `å½•åƒ`
- `å®‰é˜²`, `å¼‚å¸¸`, `æ´»åŠ¨`

### ç»¼åˆæŸ¥è¯¢æ¨¡å¼
- åŒ…å«ä¸¤ç±»å…³é”®è¯: `"æˆ‘ç”¨è½¯ä»¶æ—¶ç›‘æ§åˆ°äº†ä»€ä¹ˆï¼Ÿ"`
- æ€»ç»“æ€§æŸ¥è¯¢: `"æ˜¨å¤©éƒ½åšäº†ä»€ä¹ˆï¼Ÿ"`
- æ˜ç¡®è¦æ±‚: `"å…¨éƒ¨æ´»åŠ¨"`, `"ç»¼åˆæƒ…å†µ"`

## æ•°æ®å­˜å‚¨è®¾è®¡

### è§†é¢‘ç›‘æ§æ•°æ® (rag_server.py)
- **å­˜å‚¨**: ChromaDB (`chroma_db/`)
- **æ ¼å¼**: ç›‘æ§æ–‡æœ¬è®°å½• + æ—¶é—´æˆ³å…ƒæ•°æ®
- **ç‰¹ç‚¹**: æ”¯æŒ"ä»Šå¤©"ç­‰æ—¶é—´è¿‡æ»¤

### æ¡Œé¢æ´»åŠ¨æ•°æ® (activity_retriever.py)  
- **å­˜å‚¨**: SQLite + ChromaDB (`chroma_db_activity/`)
- **æ ¼å¼**: OCRæ–‡æœ¬ + åº”ç”¨å…ƒæ•°æ® + ç²¾ç¡®æ—¶é—´æˆ³
- **ç‰¹ç‚¹**: æ”¯æŒå¤æ‚æ—¶é—´è§£æ ("æ˜¨å¤©ä¸‹åˆ", "è¿‡å»5åˆ†é’Ÿ")

### ä¸ºä»€ä¹ˆä¸åˆå¹¶æ•°æ®åº“ï¼Ÿ

1. **æ•°æ®ç‰¹æ€§ä¸åŒ**: ç›‘æ§è®°å½•vså±å¹•æ´»åŠ¨æœ‰ä¸åŒçš„å…ƒæ•°æ®ç»“æ„
2. **æ—¶é—´å¤„ç†ä¸åŒ**: ä¸¤ç§ç³»ç»Ÿçš„æ—¶é—´è¿‡æ»¤ç­–ç•¥å·®å¼‚è¾ƒå¤§
3. **æ‰©å±•æ€§**: ç‹¬ç«‹æ•°æ®åº“ä¾¿äºå•ç‹¬ç»´æŠ¤å’Œä¼˜åŒ–
4. **å¯é æ€§**: ä¸€ä¸ªç³»ç»Ÿæ•…éšœä¸å½±å“å¦ä¸€ä¸ªç³»ç»Ÿ

## ä½¿ç”¨ç¤ºä¾‹

### Pythonä»£ç è°ƒç”¨

```python
import asyncio
from unified_retriever import unified_query, get_daily_summary

async def example():
    # å•ä¸ªæŸ¥è¯¢
    result = await unified_query("æˆ‘æ˜¨å¤©ç”¨äº†ä»€ä¹ˆè½¯ä»¶ï¼Ÿ")
    print(f"æŸ¥è¯¢ç±»å‹: {result['query_type']}")
    print(f"å›ç­”: {result['answer']}")
    
    # æ¯æ—¥æ€»ç»“
    summary = await get_daily_summary("ä»Šå¤©")
    print(f"æ€»ç»“: {summary['summary']}")

asyncio.run(example())
```

### HTTP APIè°ƒç”¨

```bash
# ç»Ÿä¸€æŸ¥è¯¢
curl -X POST http://localhost:8085/unified_query/ \
  -H "Content-Type: application/json" \
  -d '{"query": "æˆ‘ä»Šå¤©åšäº†ä»€ä¹ˆï¼Ÿ"}'

# æ¯æ—¥æ€»ç»“  
curl -X POST http://localhost:8085/daily_summary/
```

## æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡ŒæŸ¥è¯¢
- ç»¼åˆæŸ¥è¯¢æ—¶å¹¶è¡Œè°ƒç”¨ä¸¤ä¸ªç³»ç»Ÿ
- å¼‚æ­¥å¤„ç†é¿å…é˜»å¡
- å¼‚å¸¸éš”ç¦»ç¡®ä¿ç³»ç»Ÿå¯ç”¨æ€§

### ç¼“å­˜ç­–ç•¥ (å¯é€‰æ‰©å±•)
```python
# å¯ä»¥ä¸ºé¢‘ç¹æŸ¥è¯¢æ·»åŠ ç¼“å­˜
from functools import lru_cache

@lru_cache(maxsize=128)
def cached_query(query_hash):
    # ç¼“å­˜æŸ¥è¯¢ç»“æœ
    pass
```

### è´Ÿè½½å‡è¡¡ (ç”Ÿäº§ç¯å¢ƒ)
```bash
# ä½¿ç”¨nginxè¿›è¡Œè´Ÿè½½å‡è¡¡
upstream unified_retriever {
    server 127.0.0.1:8085;
    server 127.0.0.1:8086;
}
```

## æ•…éšœå¤„ç†

### ç³»ç»Ÿé™çº§
- å¦‚æœç»Ÿä¸€æ£€ç´¢å™¨ä¸å¯ç”¨ï¼Œè‡ªåŠ¨å›é€€åˆ°åŸæœ‰çš„ `detect_intent` é€»è¾‘
- å•ä¸ªç³»ç»Ÿæ•…éšœæ—¶ï¼Œä»å¯æä¾›å¦ä¸€ä¸ªç³»ç»Ÿçš„æœåŠ¡

### é”™è¯¯ç›‘æ§
```python
# æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•
import logging
logging.basicConfig(level=logging.INFO)

# ç›‘æ§å…³é”®æŒ‡æ ‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- ç³»ç»Ÿå¯ç”¨æ€§
- é”™è¯¯ç‡ç»Ÿè®¡
```

## æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ æ–°çš„æ•°æ®æº
```python
class UnifiedRetriever:
    def _query_new_system(self, query: str):
        # æ·»åŠ æ–°çš„æ£€ç´¢ç³»ç»Ÿ
        pass
```

### 2. æ”¹è¿›æ„å›¾è¯†åˆ«
```python
# ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹è¿›è¡Œæ„å›¾åˆ†ç±»
from sklearn.naive_bayes import MultinomialNB

def ml_intent_detection(query: str):
    # æ›´ç²¾ç¡®çš„æ„å›¾è¯†åˆ«
    pass
```

### 3. ç»“æœåå¤„ç†
```python
def enhance_results(raw_results: dict):
    # æ·»åŠ ç»“æœå¢å¼ºã€å»é‡ã€æ’åºç­‰
    pass
```

## ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¿—ç›‘æ§
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
tail -f rag_server.log

# æ£€æŸ¥é”™è¯¯
grep "ERROR" rag_server.log
```

### æ•°æ®åº“ç»´æŠ¤
```bash
# æ¸…ç†è¿‡æœŸæ•°æ® (å¯é€‰)
# ChromaDBä¼šè‡ªåŠ¨ç®¡ç†å­˜å‚¨

# å¤‡ä»½SQLiteæ•°æ®åº“
cp screen_recordings/activity_log.db backup/
```

### æ€§èƒ½ç›‘æ§
```python
# æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
import time
from collections import defaultdict

query_metrics = defaultdict(list)

def track_performance(query_type, response_time):
    query_metrics[query_type].append(response_time)
```

## å¸¸è§é—®é¢˜

### Q: ç»Ÿä¸€æ£€ç´¢å™¨åˆå§‹åŒ–å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥ä¾èµ–æ¨¡å—æ˜¯å¦æ­£ç¡®å®‰è£…ï¼Œç¡®ä¿ `activity_retriever.py` å’Œç›¸å…³æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ã€‚

### Q: æŸ¥è¯¢ç»“æœä¸å‡†ç¡®ï¼Ÿ
A: æ£€æŸ¥æ„å›¾è¯†åˆ«é€»è¾‘ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å…³é”®è¯æˆ–å¢åŠ æ–°çš„è¯†åˆ«è§„åˆ™ã€‚

### Q: æ€§èƒ½è¾ƒæ…¢ï¼Ÿ  
A: è€ƒè™‘å‡å°‘æ£€ç´¢çš„æ–‡æ¡£æ•°é‡(kå€¼)ï¼Œæˆ–å¢åŠ ç¼“å­˜æœºåˆ¶ã€‚

### Q: æ•°æ®åº“é”™è¯¯ï¼Ÿ
A: æ£€æŸ¥ChromaDBå’ŒSQLiteæ–‡ä»¶æƒé™ï¼Œç¡®ä¿å‘é‡æ•°æ®åº“åˆå§‹åŒ–æ­£å¸¸ã€‚

## æ€»ç»“

è¿™ä¸ªç»Ÿä¸€æ£€ç´¢ç³»ç»ŸæˆåŠŸå°†ä¸¤ä¸ªç‹¬ç«‹çš„æ£€ç´¢ç³»ç»Ÿæ•´åˆä¸ºä¸€ä¸ªæ™ºèƒ½çš„æŸ¥è¯¢æ¥å£ï¼Œæ—¢ä¿æŒäº†å„è‡ªç³»ç»Ÿçš„ä¼˜åŠ¿ï¼Œåˆæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚é€šè¿‡æ™ºèƒ½æ„å›¾è¯†åˆ«å’Œå¹¶è¡ŒæŸ¥è¯¢ï¼Œç”¨æˆ·å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€åŒæ—¶æ£€ç´¢è§†é¢‘ç›‘æ§å’Œæ¡Œé¢æ´»åŠ¨æ•°æ®ã€‚ 